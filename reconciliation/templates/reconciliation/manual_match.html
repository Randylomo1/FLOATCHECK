{% extends "reconciliation/base.html" %}

{% block title %}Manual Match{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2><i class="bi bi-link-45deg"></i> Manual Reconciliation</h2>
    <p>Review the transaction and select the best matching invoice from the suggestions below, or search for another one.</p>

    <div class="row">
        <div class="col-md-5">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">Transaction Details</div>
                <div class="card-body">
                    <h5 class="card-title">Transaction #{{ transaction.id }}</h5>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><b>Timestamp:</b> {{ transaction.timestamp|date:"Y-m-d H:i:s" }}</li>
                        <li class="list-group-item"><b>Amount:</b> <span class="fw-bold text-success">{{ transaction.currency }} {{ transaction.amount|floatformat:2 }}</span></li>
                        <li class="list-group-item"><b>Source:</b> {{ transaction.source.get_source_type_display }}</li>
                        <li class="list-group-item"><b>Reference ID:</b> {{ transaction.reference_id|default:"N/A" }}</li>
                        <li class="list-group-item"><b>Payer Info:</b> {{ transaction.payer_info|default:"N/A" }}</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-7">
            <div class="card">
                <div class="card-header bg-success text-white">Suggested Invoices</div>
                <div class="card-body">
                    {% if suggested_invoices %}
                        <form method="POST" action="{% url 'reconciliation:manual_match' transaction.id %}">
                            {% csrf_token %}
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th scope="col">Select</th>
                                        <th scope="col">Invoice #</th>
                                        <th scope="col">Customer</th>
                                        <th scope="col">Amount Due</th>
                                        <th scope="col">Due Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for invoice in suggested_invoices %}
                                        <tr>
                                            <td><input type="radio" name="invoice_id" value="{{ invoice.id }}" id="invoice_{{ invoice.id }}"></td>
                                            <td><label for="invoice_{{ invoice.id }}">{{ invoice.invoice_number }}</label></td>
                                            <td>{{ invoice.customer_name }}</td>
                                            <td class="text-end">{{ transaction.currency }} {{ invoice.amount_due|floatformat:2 }}</td>
                                            <td>{{ invoice.due_date|date:"Y-m-d" }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success">Match Selected Invoice</button>
                            </div>
                        </form>
                    {% else %}
                        <div class="alert alert-warning" role="alert">
                            <i class="bi bi-emoji-frown"></i> No invoices with a matching amount were found.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
